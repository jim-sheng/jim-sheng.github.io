<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录生活的每一滴"><title>lapis-数据库连接和查询 | 盛国存</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">lapis-数据库连接和查询</h1><a id="logo" href="/.">盛国存</a><p class="description">个人博客</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">lapis-数据库连接和查询</h1><div class="post-meta"><a href="/blog/2018/10/26/lapis-database-access-and-query/#comments" class="comment-count"></a><p><span class="date">Oct 26, 2018</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>【原文】 <a href="http://leafo.net/lapis/reference/database.html" target="_blank" rel="noopener">http://leafo.net/lapis/reference/database.html</a></p>
<p><code>Lapis</code> 有一系列的 <code>class</code> 和 <code>function</code> 用于 <code>PostgreSQL</code> 和 <code>MySQL</code> 的操作。未来将会支持更多的数据库。与此同时，你也可以使用 <code>OpenResty</code> 的数据库驱动，而不使用 <code>Lapis</code> 的查询 <code>API</code>。</p>
<p>这里的每一个查询都是基于 <code>OpenResty cosocket API</code> 实现的异步查询。<code>yield</code> 和 <code>resume</code> 这些操作都是自动处理的；同时如果是异步环境，查询也可以顺序写入。另外会创建连接池以获得更好的性能。</p>
<p>具体细节看你使用的是什么数据库，以及使用的是哪个三方库：</p>
<p><code>pgmoon</code> 是 <code>PostgreSQL</code> 的驱动。它的优势是除了命令行使用 <code>LuaSocket</code> 的同步 <code>API</code>，其它的都使用 <code>OpenResty cosocket API</code>。</p>
<p>在服务器的上下文中，<code>lua-resty-mysql</code> 是 <code>MySQL</code> 的驱动。当在命令行中是 <code>LuaSQL</code>。</p>
<h2 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a>建立连接</h2><p>你先需要创建你的数据库的配置</p>
<h3 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a><code>PostgreSQL</code></h3><p>如果你使用的是 <code>PostgreSQL</code> ，你需要在 <code>config.lua</code> 中创建一个 <code>postgres</code> 块。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-- config.lua</span><br><span class="line">local<span class="built_in"> config </span>= require(<span class="string">"lapis.config"</span>)</span><br><span class="line">config(<span class="string">"development"</span>, &#123;</span><br><span class="line">  postgres = &#123;</span><br><span class="line">    host = <span class="string">"127.0.0.1"</span>,</span><br><span class="line">   <span class="built_in"> user </span>= <span class="string">"pg_user"</span>,</span><br><span class="line">    password = <span class="string">"the_password"</span>,</span><br><span class="line">    database = <span class="string">"my_database"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><code>host</code> 默认值是 <code>127.0.0.1</code>， <code>user</code> 默认值是 <code>postgres</code>，所以你看你的配置都默认值没有区别的话可以直接去掉。如果没有使用默认的端口号，你可以直接跟在 <code>host</code> 的后面，语法如下：<code>my_host:1234</code> （否则 <code>5432</code>， 这是 <code>PostgreSQL</code> 的默认值）。</p>
<h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a><code>MySQL</code></h3><p>如果你使用的是 <code>MySQL</code> ，和上面是类似的；你需呀定义一个 <code>mysql</code> 块：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-- config.lua</span><br><span class="line">local<span class="built_in"> config </span>= require(<span class="string">"lapis.config"</span>)</span><br><span class="line">config(<span class="string">"development"</span>, &#123;</span><br><span class="line">  mysql = &#123;</span><br><span class="line">    host = <span class="string">"127.0.0.1"</span>,</span><br><span class="line">   <span class="built_in"> user </span>= <span class="string">"mysql_user"</span>,</span><br><span class="line">    password = <span class="string">"the_password"</span>,</span><br><span class="line">    database = <span class="string">"my_database"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>现在你可以开始查询操作了。</p>
<h2 id="创建一个查询"><a href="#创建一个查询" class="headerlink" title="创建一个查询"></a>创建一个查询</h2><p>这是两种查询的方式：</p>
<ul>
<li>使用原生的 <code>SQL</code> 查询，也就是我们常说的裸写 <code>SQL</code>。</li>
<li><code>Model</code> 类里面封装了常见的查询，可以直接使用。</li>
</ul>
<p>优先选择使用 <code>Model</code> 里面的方法。当然有些复杂的操作还是选择使用原生的 <code>SQL</code> 查询更加的方便。</p>
<p>以下是一个裸写 <code>SQL</code> 的事例：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> lapis = <span class="built_in">require</span>(<span class="string">"lapis"</span>)</span><br><span class="line"><span class="keyword">local</span> db = <span class="built_in">require</span>(<span class="string">"lapis.db"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> app = lapis.Application()</span><br><span class="line"></span><br><span class="line">app:<span class="built_in">match</span>(<span class="string">"/"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">local</span> res = db.query(<span class="string">"select * from my_table where id = ?"</span>, <span class="number">10</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"ok!"</span></span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>
<p>下面是使用 <code>Model</code> 实现同样的功能：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> lapis = <span class="built_in">require</span>(<span class="string">"lapis"</span>)</span><br><span class="line"><span class="keyword">local</span> Model = <span class="built_in">require</span>(<span class="string">"lapis.db.model"</span>).Model</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> app = lapis.Application()</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> MyTable = Model:extend(<span class="string">"my_table"</span>)</span><br><span class="line"></span><br><span class="line">app:<span class="built_in">match</span>(<span class="string">"/"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">local</span> row = MyTable:<span class="built_in">find</span>(<span class="number">10</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"ok!"</span></span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>
<p>默认情况下，所有的查询都会被记录日志。你可以直接通过日志查看具体的操作。</p>
<h2 id="查询接口"><a href="#查询接口" class="headerlink" title="查询接口"></a>查询接口</h2><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">local</span> db = <span class="keyword">require</span>(<span class="string">"lapis.db"</span>)</span><br></pre></td></tr></table></figure>
<p>这个 <code>db</code> 模块提供了如下的方法：</p>
<h3 id="query-query-params"><a href="#query-query-params" class="headerlink" title="query(query, params...)"></a><code>query(query, params...)</code></h3><p>执行原生的查询。如果查询成功会返回一个结果集，如果失败会返回一个 <code>nil</code>。</p>
<p>第一个参数就是要被执行的 <code>SQL</code> 语句。如果 <code>SQL</code> 语句中包含 <code>?</code> 会使用后面的参数的值依次替换。后面的参数在赋值 <code>SQL</code> 语句之前会进行 <code>escape_literal</code> 转换操作，避免 <code>SQL</code> 注入的问题。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">local res</span><br><span class="line"></span><br><span class="line">res = db.query("<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> hello<span class="string">")</span></span><br><span class="line"><span class="string">res = db.query("</span><span class="keyword">UPDATE</span> things <span class="keyword">SET</span> color = ?<span class="string">", "</span>blue<span class="string">")</span></span><br><span class="line"><span class="string">res = db.query("</span><span class="keyword">INSERT</span> <span class="keyword">INTO</span> cats (age, <span class="keyword">name</span>, alive) <span class="keyword">VALUES</span> (?, ?, ?)<span class="string">", 25, "</span>dogman<span class="string">", true)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> hello</span><br><span class="line"><span class="keyword">UPDATE</span> things <span class="keyword">SET</span> color = <span class="string">'blue'</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> cats (age, <span class="keyword">name</span>, alive) <span class="keyword">VALUES</span> (<span class="number">25</span>, <span class="string">'dogman'</span>, <span class="literal">TRUE</span>)</span><br></pre></td></tr></table></figure>
<p>如果查询失败会向上抛出一个 <code>Lua</code> 错误。错误信息包含查询的错误信息。</p>
<h3 id="select-query-params"><a href="#select-query-params" class="headerlink" title="select(query, params...)"></a><code>select(query, params...)</code></h3><p>几乎和 <code>query</code> 的功能一样除了在查询语句前面的 <code>&quot;SELECT&quot;</code>。</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> res = db.<span class="keyword">select</span>(<span class="string">"* from hello where active = ?"</span>, db.<span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> hello <span class="keyword">where</span> active = <span class="literal">FALSE</span></span><br></pre></td></tr></table></figure>
<h3 id="insert-table-values-returning"><a href="#insert-table-values-returning" class="headerlink" title="insert(table, values, returning...)"></a><code>insert(table, values, returning...)</code></h3><p>向表里插入一行数据， <code>values</code> 就是列名和值。</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.insert(<span class="string">"my_table"</span>, &#123;</span><br><span class="line">  <span class="attr">age</span> = <span class="number">10</span>,</span><br><span class="line">  <span class="attr">name</span> = <span class="string">"Hello World"</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">"my_table"</span> (<span class="string">"age"</span>, <span class="string">"name"</span>) <span class="keyword">VALUES</span> (<span class="number">10</span>, <span class="string">'Hello World'</span>)</span><br></pre></td></tr></table></figure>
<p>当然也可以指定插入行的数据的某一列作为返回值：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> res = db.insert(<span class="string">"some_other_table"</span>, &#123;</span><br><span class="line">  <span class="built_in">name</span> = <span class="string">"Hello World"</span></span><br><span class="line">&#125;, <span class="string">"id"</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">"some_other_table"</span> (<span class="string">"name"</span>) <span class="keyword">VALUES</span> (<span class="string">'Hello World'</span>) <span class="keyword">RETURNING</span> <span class="string">"id"</span></span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：<code>RETURNING</code> 这个是 <code>PostgreSQL</code> 的特性，<code>MySQL</code> 没有。</p>
<h3 id="update-table-values-conditions-params"><a href="#update-table-values-conditions-params" class="headerlink" title="update(table, values, conditions, params...)"></a><code>update(table, values, conditions, params...)</code></h3><p>更新表中满足 <code>conditions</code> 条件的所有的值。</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.update(<span class="string">"the_table"</span>, &#123;</span><br><span class="line">  <span class="attr">name</span> = <span class="string">"Dogbert 2.0"</span>,</span><br><span class="line">  <span class="attr">active</span> = <span class="literal">true</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  <span class="attr">id</span> = <span class="number">100</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> <span class="string">"the_table"</span> <span class="keyword">SET</span> <span class="string">"name"</span> = <span class="string">'Dogbert 2.0'</span>, <span class="string">"active"</span> = <span class="literal">TRUE</span> <span class="keyword">WHERE</span> <span class="string">"id"</span> = <span class="number">100</span></span><br></pre></td></tr></table></figure>
<p><code>conditions</code> 也可以是字符串，<code>params</code> 将要替换掉其中需要替换的值：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">db</span>.<span class="keyword">update</span>(<span class="string">"the_table"</span>, &#123;</span><br><span class="line">  <span class="keyword">count</span> = <span class="keyword">db</span>.raw(<span class="string">"count + 1"</span>)</span><br><span class="line">&#125;, <span class="string">"count &lt; ?"</span>, 10)</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> <span class="string">"the_table"</span> <span class="keyword">SET</span> <span class="string">"count"</span> = <span class="keyword">count</span> + <span class="number">1</span> <span class="keyword">WHERE</span> <span class="keyword">count</span> &lt; <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>当 <code>conditions</code> 是一个 <code>table</code> 的时候，所有的其它的参数会被用于 <code>&quot;RETURNING&quot;</code>：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">db</span>.<span class="keyword">update</span>(<span class="string">"cats"</span>, &#123;</span><br><span class="line">  <span class="keyword">count</span> = <span class="keyword">db</span>.raw(<span class="string">"count + 1"</span>)</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  id = 1200</span><br><span class="line">&#125;, <span class="string">"count"</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> <span class="string">"cats"</span> <span class="keyword">SET</span> <span class="string">"count"</span> = <span class="keyword">count</span> + <span class="number">1</span>, <span class="keyword">WHERE</span> <span class="string">"id"</span> = <span class="number">1200</span> <span class="keyword">RETURNING</span> <span class="keyword">count</span></span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：<code>RETURNING</code> 这个是 <code>PostgreSQL</code> 的特性，<code>MySQL</code> 没有。</p>
<h3 id="delete-table-conditions-params"><a href="#delete-table-conditions-params" class="headerlink" title="delete(table, conditions, params...)"></a><code>delete(table, conditions, params...)</code></h3><p>删除表中的符合 <code>conditions</code> 条件的数据。</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="keyword">delete</span>(<span class="string">"cats"</span>, &#123; name = <span class="string">"Roo"</span> &#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> <span class="string">"cats"</span> <span class="keyword">WHERE</span> <span class="string">"name"</span> = <span class="string">'Roo'</span></span><br></pre></td></tr></table></figure>
<p><code>conditions</code> 也可以是一个字符串</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="keyword">delete</span>(<span class="string">"cats"</span>, <span class="string">"name = ?"</span>, <span class="string">"Gato"</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> <span class="string">"cats"</span> <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'Gato'</span></span><br></pre></td></tr></table></figure>
<h3 id="raw-str"><a href="#raw-str" class="headerlink" title="raw(str)"></a><code>raw(str)</code></h3><p>返回一个原始的数据，不会被转换：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">db</span>.<span class="keyword">update</span>(<span class="string">"the_table"</span>, &#123;</span><br><span class="line">  <span class="keyword">count</span> = <span class="keyword">db</span>.raw(<span class="string">"count + 1"</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">db</span>.select(<span class="string">"* from another_table where x = ?"</span>, <span class="keyword">db</span>.raw(<span class="string">"now()"</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> <span class="string">"the_table"</span> <span class="keyword">SET</span> <span class="string">"count"</span> = <span class="keyword">count</span> + <span class="number">1</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> another_table <span class="keyword">where</span> x = <span class="keyword">now</span>()</span><br></pre></td></tr></table></figure>
<h3 id="list-values"><a href="#list-values" class="headerlink" title="list({values...})"></a><code>list({values...})</code></h3><p>会按照 <code>SQL</code> 的 <code>list</code> 的语法转换成指定的数据。</p>
<p>这个函数通常在查询时使用。同时里面的数据在传递给 <code>SQL</code> 之前会经过 <code>escape_literal</code> 进行转义操作。</p>
<p>同时我们也可以用在数据库更新的场景下：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> ids = <span class="keyword">db</span>.<span class="keyword">list</span>(&#123;3,2,1,5&#125;)</span><br><span class="line"><span class="keyword">local</span> res = <span class="keyword">db</span>.select(<span class="string">"* from another table where id in ?"</span>, ids)</span><br><span class="line"></span><br><span class="line"><span class="keyword">db</span>.<span class="keyword">update</span>(<span class="string">"the_table"</span>, &#123;</span><br><span class="line">  height = 55</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  id = ids</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> another <span class="keyword">table</span> <span class="keyword">where</span> <span class="keyword">id</span> <span class="keyword">in</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line"><span class="keyword">UPDATE</span> <span class="string">"the_table"</span> <span class="keyword">SET</span> <span class="string">"height"</span> = <span class="number">55</span> <span class="keyword">WHERE</span> <span class="string">"ids"</span> <span class="keyword">IN</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<h3 id="array-values"><a href="#array-values" class="headerlink" title="array({values...})"></a><code>array({values...})</code></h3><p>在 <code>PostgreSQL</code> 中将数据转换成数组进行插入／更新操作的。<code>MySQL</code> 里面没有这个功能。</p>
<p>可以在任意的常规的<code>SQL</code>传值查询操作中。在查询前所有的数据都会被 <code>escape_literal</code> 进行转义操作。</p>
<p>参数会被转换，不是单纯的拷贝。在使用过程中需要注意这一点。</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="keyword">insert</span>(<span class="string">"some_table"</span>, &#123;</span><br><span class="line">  tags = db.array(&#123;<span class="string">"hello"</span>, <span class="string">"world"</span>&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">"some_table"</span> (<span class="string">"tags"</span>) <span class="keyword">VALUES</span> (<span class="built_in">ARRAY</span>[<span class="string">'hello'</span>,<span class="string">'world'</span>])</span><br></pre></td></tr></table></figure>
<h3 id="escape-literal-value"><a href="#escape-literal-value" class="headerlink" title="escape_literal(value)"></a><code>escape_literal(value)</code></h3><p>数据转义功能。任何数据都可以使用进行转义。<code>Number</code> 、 <code>string</code> 、 <code>boolean</code> 都会被相应的转义。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> escaped = <span class="keyword">db</span>.escape_literal(value)</span><br><span class="line"><span class="keyword">local</span> res = <span class="keyword">db</span>.<span class="keyword">query</span>(<span class="string">"select * from hello where id = "</span> .. escaped)</span><br></pre></td></tr></table></figure>
<p><code>escape_literal</code> 不适合表名、列名。具体想对表名操作可以看 <code>escape_identifier</code>。</p>
<h3 id="escape-identifier-str"><a href="#escape-identifier-str" class="headerlink" title="escape_identifier(str)"></a><code>escape_identifier(str)</code></h3><p>用于转换一个字符串用于查询中的标识符。标识符通常是列名、表名等。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> table_name = <span class="keyword">db</span>.escape_identifier(<span class="string">"table"</span>)</span><br><span class="line"><span class="keyword">local</span> res = <span class="keyword">db</span>.<span class="keyword">query</span>(<span class="string">"select * from "</span> .. table_name)</span><br></pre></td></tr></table></figure>
<p><code>escape_identifier</code> 不适合转义值。想对值进行转义可以看 <code>escape_literal</code>。</p>
<h3 id="interpolate-query-query"><a href="#interpolate-query-query" class="headerlink" title="interpolate_query(query, ...)"></a><code>interpolate_query(query, ...)</code></h3><p>用于替换查询语句中的 <code>?</code>，剩下的参数的转义通过 <code>escape_literal</code>。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">local <span class="selector-tag">q</span> = <span class="string">"select * from table"</span></span><br><span class="line"><span class="selector-tag">q</span> = <span class="selector-tag">q</span> .. db.interpolate_query(<span class="string">"where value = ?"</span>, <span class="number">42</span>)</span><br><span class="line">local res = db.query(q)</span><br></pre></td></tr></table></figure>
<h3 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h3><p>以下是常见的常量：</p>
<ul>
<li><code>NULL</code> – 代表 <code>SQL</code> 里面的 <code>NULL</code></li>
<li><code>TRUE</code> – 代表 <code>SQL</code> 里面的 <code>TRUE</code></li>
<li><code>FALSE</code> – 代表 <code>SQL</code> 里面的 <code>FALSE</code></li>
</ul>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">db</span>.<span class="keyword">update</span>(<span class="string">"the_table"</span>, &#123;</span><br><span class="line">  name = <span class="keyword">db</span>.NULL</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="数据库模式"><a href="#数据库模式" class="headerlink" title="数据库模式"></a>数据库模式</h2><p><code>Lapis</code> 在 <code>lapis.db.schema</code> 模块中提供了一系列的创建数据的模式。</p>
<h3 id="创建和drop表"><a href="#创建和drop表" class="headerlink" title="创建和drop表"></a>创建和<code>drop</code>表</h3><h4 id="create-table-table-name-table-declarations"><a href="#create-table-table-name-table-declarations" class="headerlink" title="create_table(table_name, { table_declarations... })"></a><code>create_table(table_name, { table_declarations... })</code></h4><p>第一个参数是需要创建的表名称，第二个参数一个 <code>table</code> 里面存储着这张表的细节。</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">local <span class="keyword">schema</span> = require(<span class="string">"lapis.db.schema"</span>)</span><br><span class="line"></span><br><span class="line">local types = <span class="keyword">schema</span>.types</span><br><span class="line"></span><br><span class="line"><span class="keyword">schema</span>.create_table(<span class="string">"users"</span>, &#123;</span><br><span class="line">  &#123;<span class="string">"id"</span>, types.serial&#125;,</span><br><span class="line">  &#123;<span class="string">"username"</span>, types.varchar&#125;,</span><br><span class="line"></span><br><span class="line">  <span class="string">"PRIMARY KEY (id)"</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：在 <code>MySQL</code> 中你可以用 <code>types.id</code> 去设置自增主键 <code>ID</code>。不可以使用 <code>PRIMARY KEY (id)</code>。</p>
<p> 上面的例子会被解析成下面的 <code>SQL</code>：</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">"users"</span> (</span><br><span class="line">  <span class="string">"id"</span> <span class="built_in">serial</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">"username"</span> <span class="built_in">character</span> <span class="built_in">varying</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>第二个参数可以是字符串，也可以是<code>table</code>。如果是一个 <code>table</code> 的话，会默认以 <code>column / type</code> 的格式进行解析：</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; column_name, column_<span class="keyword">type</span> &#125;</span><br></pre></td></tr></table></figure>
<p>它们都是普通的字符串。列名会被自动进行转义。列类型会被 <code>toString</code> 处理后进行传输。<code>schema.types</code> 有一系列的类型可选。例如，<code>schema.types.varchar</code> 等同于 <code>character varying(255) NOT NULL</code>。更多例子下面会继续详细阐述。</p>
<p>如果第二次参数是字符串会被直接插入<code>CREATE TABLE</code> 语句中，比如上面的创建主键的例子。</p>
<h4 id="drop-table-table-name"><a href="#drop-table-table-name" class="headerlink" title="drop_table(table_name)"></a><code>drop_table(table_name)</code></h4><p><code>drop</code> 一张表。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">schema</span><span class="selector-class">.drop_table</span>(<span class="string">"users"</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">"users"</span>;</span><br></pre></td></tr></table></figure>
<h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><h4 id="create-index-table-name-col1-col2-options"><a href="#create-index-table-name-col1-col2-options" class="headerlink" title="create_index(table_name, col1, col2..., [options])"></a><code>create_index(table_name, col1, col2..., [options])</code></h4><p><code>create_index</code> 用于常见表的索引。第一个参数是表名，其余的参数就是需要创建索引的列。最后一个参数可选，可以是一个 <code>table</code> 类型。</p>
<p>有两个可选值 <code>unique: BOOL</code>, <code>where: clause_string</code>。</p>
<p><code>create_index</code> 创建索引之前会去检查这个索引是否存在。如果存在就什么都不做。</p>
<p>下面就是一个创建索引的例子:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">local create_index = schema.create_index</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">create_index</span><span class="params">(<span class="string">"users"</span>, <span class="string">"created_at"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">create_index</span><span class="params">(<span class="string">"users"</span>, <span class="string">"username"</span>, &#123; unique = true &#125;)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">create_index</span><span class="params">(<span class="string">"posts"</span>, <span class="string">"category"</span>, <span class="string">"title"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">create_index</span><span class="params">(<span class="string">"uploads"</span>, <span class="string">"name"</span>, &#123; where = <span class="string">"not deleted"</span> &#125;)</span></span></span><br></pre></td></tr></table></figure>
<p>解析成 <code>SQL</code> 语句就是：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> <span class="keyword">ON</span> <span class="string">"users"</span> (created_at);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> <span class="keyword">ON</span> <span class="string">"users"</span> (username);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> <span class="keyword">ON</span> <span class="string">"posts"</span> (<span class="keyword">category</span>, title);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> <span class="keyword">ON</span> <span class="string">"uploads"</span> (<span class="keyword">name</span>) <span class="keyword">WHERE</span> <span class="keyword">not</span> deleted;</span><br></pre></td></tr></table></figure>
<h4 id="drop-index-table-name-col1-col2"><a href="#drop-index-table-name-col1-col2" class="headerlink" title="drop_index(table_name, col1, col2...)"></a><code>drop_index(table_name, col1, col2...)</code></h4><p>删除表的索引。跟创建索引几乎类似。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">local drop_index = schema.drop_index</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">drop_index</span><span class="params">(<span class="string">"users"</span>, <span class="string">"created_at"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">drop_index</span><span class="params">(<span class="string">"posts"</span>, <span class="string">"title"</span>, <span class="string">"published"</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>解析成 <code>SQL</code> 如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">INDEX</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">"users_created_at_idx"</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">INDEX</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">"posts_title_published_idx"</span></span><br></pre></td></tr></table></figure>
<h3 id="修改表结构"><a href="#修改表结构" class="headerlink" title="修改表结构"></a>修改表结构</h3><h4 id="add-column-table-name-column-name-column-type"><a href="#add-column-table-name-column-name-column-type" class="headerlink" title="add_column(table_name, column_name, column_type)"></a><code>add_column(table_name, column_name, column_type)</code></h4><p>给表添加一个列。</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schema.add_column(<span class="string">"users"</span>, <span class="string">"age"</span>, types.<span class="built_in">integer</span>)</span><br></pre></td></tr></table></figure>
<p>解析成 <code>SQL</code> 就如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE <span class="string">"users"</span> <span class="builtin-name">ADD</span> COLUMN <span class="string">"age"</span> integer <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0</span><br></pre></td></tr></table></figure>
<h4 id="drop-column-table-name-column-name"><a href="#drop-column-table-name-column-name" class="headerlink" title="drop_column(table_name, column_name)"></a><code>drop_column(table_name, column_name)</code></h4><p>删除列</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">schema</span><span class="selector-class">.drop_column</span>(<span class="string">"users"</span>, <span class="string">"age"</span>)</span><br></pre></td></tr></table></figure>
<p>解析成 <code>SQL</code> 为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">"users"</span> <span class="keyword">DROP</span> <span class="keyword">COLUMN</span> <span class="string">"age"</span></span><br></pre></td></tr></table></figure>
<h4 id="rename-column-table-name-old-name-new-name"><a href="#rename-column-table-name-old-name-new-name" class="headerlink" title="rename_column(table_name, old_name, new_name)"></a><code>rename_column(table_name, old_name, new_name)</code></h4><p>列名的重命名操作</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">schema</span><span class="selector-class">.rename_column</span>(<span class="string">"users"</span>, <span class="string">"age"</span>, <span class="string">"lifespan"</span>)</span><br></pre></td></tr></table></figure>
<p>解析成 <code>SQL</code> 为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">"users"</span> <span class="keyword">RENAME</span> <span class="keyword">COLUMN</span> <span class="string">"age"</span> <span class="keyword">TO</span> <span class="string">"lifespan"</span></span><br></pre></td></tr></table></figure>
<h4 id="rename-table-old-name-new-name"><a href="#rename-table-old-name-new-name" class="headerlink" title="rename_table(old_name, new_name)"></a><code>rename_table(old_name, new_name)</code></h4><p>表名重命名操作</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">schema</span><span class="selector-class">.rename_table</span>(<span class="string">"users"</span>, <span class="string">"members"</span>)</span><br></pre></td></tr></table></figure>
<p>解析成 <code>SQL</code> 为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">"users"</span> <span class="keyword">RENAME</span> <span class="keyword">TO</span> <span class="string">"members"</span></span><br></pre></td></tr></table></figure>
<h3 id="列类型"><a href="#列类型" class="headerlink" title="列类型"></a>列类型</h3><p>所有的列类型都存储在 <code>schema.types</code> 中。所有的类型都是特殊的对象，不但可以通过 <code>tostring</code> 转换成一个类型声明的字符串，还可以像自定义函数进行调用。</p>
<p>以下是所有的默认值：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">local types = require(<span class="string">"lapis.db.schema"</span>).types</span><br><span class="line"></span><br><span class="line"><span class="builtin-name">print</span>(types.boolean)       --&gt; boolean <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span><span class="literal">FALSE</span></span><br><span class="line"><span class="builtin-name">print</span>(types.date)          --&gt; date <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line"><span class="builtin-name">print</span>(types.double)        --&gt; double precision <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0</span><br><span class="line"><span class="builtin-name">print</span>(types.foreign_key)   --&gt; integer <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line"><span class="builtin-name">print</span>(types.integer)       --&gt; integer <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0</span><br><span class="line"><span class="builtin-name">print</span>(types.numeric)       --&gt; numeric <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0</span><br><span class="line"><span class="builtin-name">print</span>(types.real)          --&gt; real <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0</span><br><span class="line"><span class="builtin-name">print</span>(types.serial)        --&gt; serial <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line"><span class="builtin-name">print</span>(types.text)          --&gt; text <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line"><span class="builtin-name">print</span>(types.time)          --&gt; timestamp without time zone <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line"><span class="builtin-name">print</span>(types.varchar)       --&gt; character varying(255) <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line"><span class="builtin-name">print</span>(types.enum)          --&gt; smallint <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br></pre></td></tr></table></figure>
<p>你会发现所有的类型的默认都是 <code>NOT NULL</code>，同时数字类型默认 <code>0</code> 布尔类型默认 <code>false</code>。</p>
<p>当类型当作函数一样调用的时候，以下是可选值：</p>
<ul>
<li><code>default: value</code> – 设置默认值</li>
<li><code>null: boolean</code> – 定义列是否是 <code>NOT NULL</code></li>
<li><code>unique: boolean</code> – 定义列是否有唯一索引</li>
<li><code>primary_key: boolean</code> – 定义列是否是主键</li>
<li><code>array: bool|number</code>– 仅限 <code>PostgreSQL</code> ，设置一个几维的数组， <code>true</code> 等同于 <code>1</code></li>
</ul>
<p>以下是具体的事例：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">types.integer(&#123;<span class="built_in"> default </span>= 1, <span class="literal">null</span> = <span class="literal">true</span> &#125;)  --&gt; integer<span class="built_in"> DEFAULT </span>1</span><br><span class="line">types.integer(&#123; primary_key = <span class="literal">true</span> &#125;)        --&gt; integer <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0 PRIMARY KEY</span><br><span class="line">types.text(&#123; <span class="literal">null</span> = <span class="literal">true</span> &#125;)                  --&gt; text</span><br><span class="line">types.varchar(&#123; primary_key = <span class="literal">true</span> &#125;)        --&gt; character varying(255) <span class="keyword">NOT</span> <span class="literal">NULL</span> PRIMARY KEY</span><br><span class="line">types.real(&#123; array = <span class="literal">true</span> &#125;)                 --&gt; real[]</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：<code>MySQL</code> 的类型集和 <code>PostgreSQL</code> 完全不一样，具体请查看 <a href="https://github.com/leafo/lapis/blob/master/lapis/db/mysql/schema.moon#L162" target="_blank" rel="noopener"><code>MySQL 类型</code></a></p>
<h2 id="数据库-Migration"><a href="#数据库-Migration" class="headerlink" title="数据库 Migration"></a>数据库 <code>Migration</code></h2><p>为了迎合业务逻辑的变更，我们需要有一个机制可以同步修改我们的数据库。</p>
<p>我们通常会定义一个函数的 <code>table</code> ，<code>table</code> 的 <code>key</code> 就是 <code>migration</code> 的名称。我们可以随意定义 <code>migration</code> 的名称，当然还是建议用时间戳定义 <code>migration</code> 的名字：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> schema = <span class="built_in">require</span>(<span class="string">"lapis.db.schema"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  [<span class="number">1368686109</span>] = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    schema.add_column(<span class="string">"my_table"</span>, <span class="string">"hello"</span>, schema.types.integer)</span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line"></span><br><span class="line">  [<span class="number">1368686843</span>] = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    schema.create_index(<span class="string">"my_table"</span>, <span class="string">"hello"</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个 <code>migration</code> 函数表面看就是一个普通的函数。通常它们会调用上面的 <code>schema</code> 函数，但是实际上有些是没有必要的。</p>
<p>当启动 <code>migration</code> 时，只有没有被执行过的会被调用成功。所有已经被执行的 <code>migration</code> 会存储在 <code>migrations</code> 表中，这个表就用于存储哪些已经执行过了的 <code>migration</code> 的名字。同时所有的 <code>migration</code> 会被升序排列依次执行。</p>
<h3 id="启动-Migration"><a href="#启动-Migration" class="headerlink" title="启动 Migration"></a>启动 <code>Migration</code></h3><p><code>Lapis</code> 命令行工具又一个特殊的命令 <code>lapis migrate</code> 可以直接执行 <code>migration</code>。</p>
<p>这个命令将会调用 <code>migrations</code> 模块将上面的数据格式进行数据库操作。</p>
<p>现在我们创建一个仅有一个 <code>migration</code> 的文件:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- migrations.lua</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> schema = <span class="built_in">require</span>(<span class="string">"lapis.db.schema"</span>)</span><br><span class="line"><span class="keyword">local</span> types = schema.types</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  [<span class="number">1</span>] = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    schema.create_table(<span class="string">"articles"</span>, &#123;</span><br><span class="line">      &#123; <span class="string">"id"</span>, types.serial &#125;,</span><br><span class="line">      &#123; <span class="string">"title"</span>, types.text &#125;,</span><br><span class="line">      &#123; <span class="string">"content"</span>, types.text &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="string">"PRIMARY KEY (id)"</span></span><br><span class="line">    &#125;)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建完毕之后，可以执行 <code>lapis migrate</code> 确保可以编译为 <code>Lua</code>。这个命令首先会去判断这个表是不是存在，如果不存在，会去创建这个表，如果存在会去执行没有被执行的 <code>migration</code>。</p>
<p>后续会做进一步的展开。</p>
<h3 id="自定义启动-Migration"><a href="#自定义启动-Migration" class="headerlink" title="自定义启动 Migration"></a>自定义启动 <code>Migration</code></h3><p>我们可以创建一个 <code>migration</code> 的表，具体的代码如下：</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">local</span> migrations = <span class="keyword">require</span>(<span class="string">"lapis.db.migrations"</span>)</span><br><span class="line">migrations.create_migrations_table()</span><br></pre></td></tr></table></figure>
<p>会被解析成如下的 <code>SQL</code>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">"lapis_migrations"</span> (</span><br><span class="line">  <span class="string">"name"</span> <span class="built_in">character</span> <span class="built_in">varying</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span>(<span class="keyword">name</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>然后我们可以自定义启动 <code>migration</code> 了：</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">local</span> migrations = <span class="keyword">require</span>(<span class="string">"lapis.db.migrations"</span>)</span><br><span class="line">migrations.run_migrations(<span class="keyword">require</span>(<span class="string">"migrations"</span>))</span><br></pre></td></tr></table></figure>
<h2 id="数据库辅助功能"><a href="#数据库辅助功能" class="headerlink" title="数据库辅助功能"></a>数据库辅助功能</h2><p>这些 <code>db</code> 模块里面的辅助功能不能直接在查询接口里使用。</p>
<h3 id="format-date-time"><a href="#format-date-time" class="headerlink" title="format_date(time)"></a><code>format_date(time)</code></h3><p>返回一个数据库格式的时间字符串。</p>
<p><code>time</code> 参数是可选的，默认是 <code>UTC</code> 时间。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> date = <span class="keyword">db</span>.format_date()</span><br><span class="line"><span class="keyword">db</span>.<span class="keyword">query</span>(<span class="string">"update things set published_at = ?"</span>, date)</span><br></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/lapis/">lapis</a><a href="/tags/Lua/">Lua</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/blog/2018/10/25/lapis-lua-configuration-syntax/" class="next">lapis-Lua版本的配置语法</a></div><div id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zNjk1MS8xMzQ4Nw=="></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#建立连接"><span class="toc-text">建立连接</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PostgreSQL"><span class="toc-text">PostgreSQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL"><span class="toc-text">MySQL</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建一个查询"><span class="toc-text">创建一个查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询接口"><span class="toc-text">查询接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#query-query-params"><span class="toc-text">query(query, params...)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#select-query-params"><span class="toc-text">select(query, params...)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#insert-table-values-returning"><span class="toc-text">insert(table, values, returning...)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#update-table-values-conditions-params"><span class="toc-text">update(table, values, conditions, params...)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#delete-table-conditions-params"><span class="toc-text">delete(table, conditions, params...)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#raw-str"><span class="toc-text">raw(str)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#list-values"><span class="toc-text">list({values...})</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#array-values"><span class="toc-text">array({values...})</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#escape-literal-value"><span class="toc-text">escape_literal(value)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#escape-identifier-str"><span class="toc-text">escape_identifier(str)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#interpolate-query-query"><span class="toc-text">interpolate_query(query, ...)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常量"><span class="toc-text">常量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库模式"><span class="toc-text">数据库模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建和drop表"><span class="toc-text">创建和drop表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#create-table-table-name-table-declarations"><span class="toc-text">create_table(table_name, { table_declarations... })</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#drop-table-table-name"><span class="toc-text">drop_table(table_name)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#索引"><span class="toc-text">索引</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#create-index-table-name-col1-col2-options"><span class="toc-text">create_index(table_name, col1, col2..., [options])</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#drop-index-table-name-col1-col2"><span class="toc-text">drop_index(table_name, col1, col2...)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改表结构"><span class="toc-text">修改表结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#add-column-table-name-column-name-column-type"><span class="toc-text">add_column(table_name, column_name, column_type)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#drop-column-table-name-column-name"><span class="toc-text">drop_column(table_name, column_name)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rename-column-table-name-old-name-new-name"><span class="toc-text">rename_column(table_name, old_name, new_name)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rename-table-old-name-new-name"><span class="toc-text">rename_table(old_name, new_name)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#列类型"><span class="toc-text">列类型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库-Migration"><span class="toc-text">数据库 Migration</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#启动-Migration"><span class="toc-text">启动 Migration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义启动-Migration"><span class="toc-text">自定义启动 Migration</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库辅助功能"><span class="toc-text">数据库辅助功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#format-date-time"><span class="toc-text">format_date(time)</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/blog/2018/10/26/lapis-database-access-and-query/">lapis-数据库连接和查询</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/10/25/lapis-lua-configuration-syntax/">lapis-Lua版本的配置语法</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/10/25/lapis-creating-configuration/">lapis-配置和环境</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/10/23/Lapis-request-and-action/">Lapis-Request和Action</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/10/23/lapis-getting-started-with-lua/">创建一个Lua版本的Lapis项目</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/10/23/lapis-getting-started/">Lapis-快速开始</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/10/10/create-openresty-docker-image/">手把手教你创建OpenResty Docker镜像</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/09/19/quick-start-Vanilla-lua-web-framework/">Vanilla （lua web framework）中文文档 [2018.09.19]</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/08/01/nginx-book/">Nginx</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/05/18/automatic-investment-plan-by-golang/">基于Go语言的简易基金定投系统</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/lapis/" style="font-size: 15px;">lapis</a> <a href="/tags/Go语言/" style="font-size: 15px;">Go语言</a> <a href="/tags/基金/" style="font-size: 15px;">基金</a> <a href="/tags/定投/" style="font-size: 15px;">定投</a> <a href="/tags/OpenResty/" style="font-size: 15px;">OpenResty</a> <a href="/tags/Lua/" style="font-size: 15px;">Lua</a> <a href="/tags/Lapis/" style="font-size: 15px;">Lapis</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/基础概念/" style="font-size: 15px;">基础概念</a> <a href="/tags/GDB/" style="font-size: 15px;">GDB</a> <a href="/tags/入门/" style="font-size: 15px;">入门</a> <a href="/tags/Vanilla中文文档/" style="font-size: 15px;">Vanilla中文文档</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">ShengGuocun.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e3ed45ce04d57be9fec7dd674aec65e0";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script><script>(function(d, s) {
  var j, e = d.getElementsByTagName('body')[0];
  if (typeof LivereTower === 'function') { return; }
  j = d.createElement(s);
  j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
  j.async = true;
  e.appendChild(j);
})(document, 'script');
</script></body></html>