<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录生活的每一滴"><title>Lapis-快速开始 | 盛国存</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Lapis-快速开始</h1><a id="logo" href="/.">盛国存</a><p class="description">个人博客</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Lapis-快速开始</h1><div class="post-meta"><a href="/blog/2018/10/23/lapis-getting-started/#comments" class="comment-count"></a><p><span class="date">Oct 23, 2018</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p><code>Lapis</code> 是一个 <code>Lua/MoonScript</code> 的 Web 框架，本译文主要翻译 <code>Lua</code> 部分；同时 <code>Lapis</code> 是基于章亦春的 <code>OpenResty</code> ，这样你的 <code>web</code> 应用可以直接运行在 <code>Nginx</code> 内部。<code>Nginx</code> 的事件循环可以让你轻松使用异步Http请求、数据库查询和其他 <code>OpenResty</code> 提供的模块。基于 <code>Lua</code> 的协程你可以编写在幕后事件驱动的同步代码。</p>
<p><code>lapis</code> 除了提供你一个 Web 框架，同时还提供了一个可以在不同配置环境中控制 <code>OpenResty</code> 的工具。即使你不是用这个框架 <code>Web</code> 相关的模块，在基于 <code>OpenResty</code> 做开发过程中它也可以节省你的开发成本。</p>
<p>这个框架包含 <code>URL</code> 路由模块、模板、<code>CSRF</code> 和 <code>Session</code> ，同时支持 <code>PostgreSQL</code> 、<code>MySQL</code> 的 <code>DB</code> 的常规的操作，以及其他 <code>Web</code> 相关的其他功能。</p>
<p>希望本文档在你使用的过程中给你提供参考。</p>
<h2 id="基本设置"><a href="#基本设置" class="headerlink" title="基本设置"></a>基本设置</h2><p>首先，需要在你的环境中安装 <code>OpenResty</code> ，然后使用 <code>LuaRocks</code> 安装 <code>Lapis</code> (记得 <code>Lua</code> 安装 5.1，这个框架不支持 5.3 版本)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> luarocks install lapis</span></span><br></pre></td></tr></table></figure>
<p>安装完成之后，命令行敲一下 <code>lapis</code> 验证一下是否安装成功，如果有类似下面的输出代表你已经安装成功了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># lapis</span></span><br><span class="line">Lapis 1.7.0</span><br><span class="line">usage: lapis &lt;action&gt; [arguments]</span><br><span class="line">using nginx: /usr/<span class="built_in">local</span>/openresty/nginx/sbin/nginx</span><br><span class="line">default environment: development</span><br><span class="line"></span><br><span class="line">Available actions:</span><br><span class="line"></span><br><span class="line">  new                              create a new lapis project <span class="keyword">in</span> the current</span><br><span class="line">                                   directory</span><br><span class="line">  server [environment]             build config and start server</span><br><span class="line">  build [environment]              build config, send HUP <span class="keyword">if</span> server running</span><br><span class="line">  term                             sends TERM signal to shut down a running</span><br><span class="line">                                   server</span><br><span class="line">  <span class="built_in">exec</span> &lt;lua-string&gt;                execute Lua on the server</span><br><span class="line">  migrate [environment]            run migrations</span><br><span class="line">  generate &lt;template&gt; [args...]    generates a new file from template</span><br><span class="line">  <span class="built_in">help</span>                             show this text</span><br></pre></td></tr></table></figure>
<h2 id="通过-Lapis-创建一个-Lua-应用"><a href="#通过-Lapis-创建一个-Lua-应用" class="headerlink" title="通过 Lapis 创建一个 Lua 应用"></a>通过 Lapis 创建一个 Lua 应用</h2><h3 id="lapis-命令行工具"><a href="#lapis-命令行工具" class="headerlink" title="lapis 命令行工具"></a><code>lapis</code> 命令行工具</h3><p><code>Lapis</code> 提供了一个命令行工具，可以创建新项目，也可以启动服务器。要是想看它都提供了哪些功能，你可以在命令敲下以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ lapis <span class="built_in">help</span></span><br></pre></td></tr></table></figure>
<p>现在进入一个新创建的目录中，创建一个新的项目：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/srv/www <span class="comment"># lapis new --lua</span></span><br><span class="line">wrote	nginx.conf</span><br><span class="line">wrote	mime.types</span><br><span class="line">wrote	app.lua</span><br><span class="line">wrote	models.lua</span><br></pre></td></tr></table></figure>
<p>这时候 <code>Lapis</code> 会创建一个基础版本的 <code>Nginx</code> 配置文件和一个空的 <code>Lapis</code> 应用。</p>
<p>下面我们先来查看一下生成的配置文件（ <code>nginx.conf</code> 是唯一的核心文件）。以下会简单概述一下这个配置文件都做了什么：</p>
<ul>
<li>所有的 <code>/static/</code> 开头的请求都会到 <code>static</code> 目录里查找指定的内容</li>
<li><code>/favicon.ico</code> 会从 <code>static/favicon.ico</code> 位置读取</li>
<li>其他的请求都会在落在你的 <code>Lua</code> 代码逻辑中</li>
</ul>
<p>当你通过命令行工具启动指定的环境，<code>nginx.conf</code> 里面的变量会从指定的环境的配置文件里面查询指定的值。下面我们我们会进一步讨论里面的细节。</p>
<h3 id="Nginx-配置文件"><a href="#Nginx-配置文件" class="headerlink" title="Nginx 配置文件"></a><code>Nginx</code> 配置文件</h3><p>让我们看下刚刚新建项目时创建的配置文件，这对于我们不管是做一个简单的发布操作还是后期开发更复杂的应用都是很有必要的。</p>
<p>下面是刚刚生成的 <code>nginx.conf</code> :</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span> <span class="variable">$&#123;&#123;NUM_WORKERS&#125;</span>&#125;;</span><br><span class="line"><span class="attribute">error_log</span> stderr <span class="literal">notice</span>;</span><br><span class="line"><span class="attribute">daemon</span> <span class="literal">off</span>;</span><br><span class="line"><span class="attribute">pid</span> logs/nginx.pid;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">  <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="attribute">include</span> mime.types;</span><br><span class="line"></span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="variable">$&#123;&#123;PORT&#125;</span>&#125;;</span><br><span class="line">    <span class="attribute">lua_code_cache</span> <span class="variable">$&#123;&#123;CODE_CACHE&#125;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">      <span class="attribute">default_type</span> text/html;</span><br><span class="line">      <span class="attribute">content_by_lua</span> <span class="string">'</span></span><br><span class="line"><span class="string">        require("lapis").serve("app")</span></span><br><span class="line"><span class="string">      '</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> /static/ &#123;</span><br><span class="line">      <span class="attribute">alias</span> static/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> /favicon.ico &#123;</span><br><span class="line">      <span class="attribute">alias</span> static/favicon.ico;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意的是，这和我们的常规的 Nginx 配置文件存在一定的差异。比如 <code>$</code> 这样的语法，在启动服务器之前会使用 Lapis 应用里面的指定环境的配置文件中的值进行填充。</p>
<p>当然也有一些有趣的配置。 <code>error_log stderr notice</code> 和 <code>daemon off</code> 让服务运行在前台，以及可以在控制台打印出日志。这对于开发的过程中是非常友好的，不过在线上还是要关闭它们的。</p>
<p><code>lua_code_cache</code> 在开发环境中尽量关闭这个开关，将其设置为 <code>off</code> 这在调试的过程中可以避免很多懵逼现象。当然线上对性能要求比较高的话，还是建议打开这个开关的，只要将其设置为 <code>on</code> 。不过该变量的默认值是 <code>off</code>.</p>
<p><code>content_by_lua</code> 里面的 <code>Lua</code> 代码逻辑处理不匹配其他 <code>location</code> 的剩余的请求。它会加载 <code>Lapis</code> 同时告诉服务器模块名称叫 <code>app</code> 。同时在执行 <code>lapis new</code> 命令之前会提供一个精简版的 <code>app</code> 模块。</p>
<h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><p><code>Lapis</code> 将 <code>build</code> 配置和启动服务器集成一个很简单的命令。</p>
<p>只需要在命令行之行 <code>lapis server</code> 。 <code>Lapis</code> 就会去查找你的 <code>OpenResty</code> 的安装目录，最后去查找 <code>nginx</code> 的二进制文件。（最后一个代表你的系统变量 <code>PATH</code> ）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"/usr/local/openresty/nginx/sbin/"</span></span><br><span class="line"><span class="string">"/usr/local/opt/openresty/bin/"</span></span><br><span class="line"><span class="string">"/usr/sbin/"</span></span><br><span class="line"><span class="string">""</span></span><br></pre></td></tr></table></figure>
<p><strong>提醒</strong> ：记得安装 <code>OpenResty</code>，而不是一个普通的 <code>Nginx</code> ， <code>Lapis</code> 会忽略掉普通的 <code>Nginx</code> 。</p>
<p>下面我们介绍一下如何启动服务器，只需要简单的一个命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ lapis server</span><br></pre></td></tr></table></figure>
<p>那些默认的配置文件会在前台引入到服务器中，只需要 <code>CTRL + C</code> 就可以停止服务器。</p>
<p>如果服务器运行在后台可以使用 <code>lapis term</code> 停止服务器。当然这个命令必须运行在应用的根目录下。这个命令会去查找 <code>PID</code> 文件，如果这个进程存在的话，会向它发送一个 <code>TERM</code> 指令。</p>
</div><div class="tags"><a href="/tags/Lapis/">Lapis</a><a href="/tags/Lua/">Lua</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/blog/2018/10/10/create-openresty-docker-image/" class="next">手把手教你创建OpenResty Docker镜像</a></div><div id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zNjk1MS8xMzQ4Nw=="></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#基本设置"><span class="toc-text">基本设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通过-Lapis-创建一个-Lua-应用"><span class="toc-text">通过 Lapis 创建一个 Lua 应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#lapis-命令行工具"><span class="toc-text">lapis 命令行工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-配置文件"><span class="toc-text">Nginx 配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动服务"><span class="toc-text">启动服务</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/blog/2018/10/23/lapis-getting-started/">Lapis-快速开始</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/10/10/create-openresty-docker-image/">手把手教你创建OpenResty Docker镜像</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/09/19/quick-start-Vanilla-lua-web-framework/">Vanilla （lua web framework）中文文档 [2018.09.19]</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/08/01/nginx-book/">Nginx</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/05/18/automatic-investment-plan-by-golang/">基于Go语言的简易基金定投系统</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/04/20/a-bite-of-golang/">A Bite of Golang</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/03/15/taste-gdb/">GDB抓虫之旅</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/01/12/hello-world/">Hello World</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/基础概念/" style="font-size: 15px;">基础概念</a> <a href="/tags/Go语言/" style="font-size: 15px;">Go语言</a> <a href="/tags/定投/" style="font-size: 15px;">定投</a> <a href="/tags/OpenResty/" style="font-size: 15px;">OpenResty</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/基金/" style="font-size: 15px;">基金</a> <a href="/tags/Lapis/" style="font-size: 15px;">Lapis</a> <a href="/tags/Lua/" style="font-size: 15px;">Lua</a> <a href="/tags/GDB/" style="font-size: 15px;">GDB</a> <a href="/tags/入门/" style="font-size: 15px;">入门</a> <a href="/tags/Vanilla中文文档/" style="font-size: 15px;">Vanilla中文文档</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">ShengGuocun.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e3ed45ce04d57be9fec7dd674aec65e0";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script><script>(function(d, s) {
  var j, e = d.getElementsByTagName('body')[0];
  if (typeof LivereTower === 'function') { return; }
  j = d.createElement(s);
  j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
  j.async = true;
  e.appendChild(j);
})(document, 'script');
</script></body></html>